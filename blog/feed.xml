<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
  <title>The espadrine blog.</title>
  <subtitle>Tech deep dives, discoveries, and analyses.</subtitle>
  <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/"/>
  <link rel="self" type="application/atom+xml" href="https://espadrine.github.io/blog/feed.xml"/>
  <id>https://espadrine.github.io/blog/feed.xml</id>
  <updated>2021-01-13T19:21:50Z</updated>
      <entry>
        <id>https://espadrine.github.io/blog/posts/mean-range-of-bell-curve-distributions.html</id>
        <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/posts/mean-range-of-bell-curve-distributions.html"/>
        <title>Mean Range of Bell Curve Distributions</title>
        <published>2021-01-13T19:21:50Z</published>
        <category term="stats"/>
<category term="crypto"/>
        <content type="html">
          <![CDATA[ <h1 id="Mean_Range_of_Bell_Curve_Distributions">Mean Range of Bell Curve Distributions <a href="#Mean_Range_of_Bell_Curve_Distributions" class="autolink-clicker" aria-hidden="true">§</a></h1>
<p><strong>Abstract:</strong>
When sampling several data points from a known statistical distribution,
a valuable indication of the spread is the range of the set of values obtained.
Since the sampling is probabilistic,
the best estimate we can hope for is the expected value of the range.
That mean range,
along with the expected maximum and minimum values of the sampling set,
are traditionally difficult to compute with existing means.
We present a novel method to perform that computation,
and its implications on the correct computation of the balls-into-bins problem.</p>
<h2 id="Generic_Derivation">1. Generic Derivation <a href="#Generic_Derivation" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Consider a distribution with probability density function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">φ</span></span></span></span>.
Its associated random variable, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span>, can be either real-valued or discrete.</p>
<p>We observe a sample of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> independent values taken from that distribution.</p>
<p>The question we ask is:
What is the range of values that have a probability ≥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span>
(across samplings of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> values) of appearing in the sample?
For instance, for a mean range, one would pick <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\gamma = \frac{1}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</p>
<p>Despite being potentially continuous, we can research the probability
that a given value appears at least once in the sample.
That is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>e</mi><mi>x</mi><mi>c</mi><mi>l</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1 - P_{excluded}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>e</mi><mi>x</mi><mi>c</mi><mi>l</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{excluded}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the probability
that the value does not appear in the sample.</p>
<p>In turn, given that the sample is independently drawn each time,
the probability that a value is not drawn once,
is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>e</mi><mi>x</mi><mi>c</mi><mi>l</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>d</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">P_{excluded} = (1 - \varphi(x))^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span>.</p>
<p>Thus, the probability that a given value is in the sample,
is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">1 - (1 - \varphi(x))^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span>.
By definition, that probability is equal to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span>.</p>
<p>We can therefore derive that the values <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> that are in range,
follow the equation:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>≥</mo><mn>1</mn><mo>−</mo><mroot><mrow><mn>1</mn><mo>−</mo><mi>γ</mi></mrow><mi>N</mi></mroot></mrow><annotation encoding="application/x-tex">\varphi(x) \geq 1 - \sqrt[N]{1 - \gamma}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.28112499999999985em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7483150000000002em;"><span style="top:-2.90665em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9588750000000001em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.9188750000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.28112499999999985em;"><span></span></span></span></span></span></span></span></span></span>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">φ</span></span></span></span> is a bell curve distribution,
the corresponding equality has two solutions for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>.</p>
<h2 id="Application_to_the_Normal">2. Application to the Normal <a href="#Application_to_the_Normal" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Some bell distributions are more easily invertible.
Thankfully, <em>this is true of the Normal distribution</em>,
which will enable us to produce good estimations for all distributions,
thanks to the <strong>central limit theorem</strong>.</p>
<p>First, let us derive the exact Normal solution.
We have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>μ</mi><mo separator="true">,</mo><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(x) = \mathcal{N}(\mu, \sigma^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mopen">(</span><span class="mord mathnormal">μ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>μ</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac></mrow></msup><msqrt><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mi>π</mi></mrow></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\varphi(x) = \frac{e^{-\frac{(x-\mu)^2}{2\sigma^2}}}{\sqrt{2\sigma^2\pi}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.9360900000000005em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0060900000000004em;"><span style="top:-2.4840359999999997em;"><span class="pstrut" style="height:3.32909em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9550540000000001em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.915054em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.08494599999999997em;"><span></span></span></span></span></span></span></span><span style="top:-3.55909em;"><span class="pstrut" style="height:3.32909em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.00609em;"><span class="pstrut" style="height:3.32909em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.32909em;"><span style="top:-3.4534200000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.250957142857143em;"><span style="top:-2.5061857142857145em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384399999999999em;"><span style="top:-2.93844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.5020714285714285em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49381428571428565em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>Thus the solution to the general inequality is:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>x</mi><mo>∈</mo><mrow><mo fence="true">[</mo><mi>μ</mi><mo>±</mo><msqrt><mrow><mo>−</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><msqrt><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mi>π</mi></mrow></msqrt><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mroot><mrow><mn>1</mn><mo>−</mo><mi>γ</mi></mrow><mi>N</mi></mroot><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></msqrt><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">x \in \left[
  \mu \pm \sqrt{-2\sigma^2
    \ln(\sqrt{2\sigma^2\pi}(1-\sqrt[N]{1-\gamma}))}
\right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.395277em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">−</span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.003929em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.9639290000000003em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.036070999999999964em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7483150000000002em;"><span style="top:-2.90665em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9588750000000001em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.9188750000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.28112499999999985em;"><span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.355277em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em;"><svg width='400em' height='1.8800000000000001em' viewBox='0 0 400000 1944' preserveAspectRatio='xMinYMin slice'><path d='M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.444723em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span>
<p>From this, we can compute the maximum and minimum exactly,
along with the mean range, which follows this formula:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>2</mn><msqrt><mrow><mo>−</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><msqrt><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mi>π</mi></mrow></msqrt><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mroot><mrow><mn>1</mn><mo>−</mo><mi>γ</mi></mrow><mi>N</mi></mroot><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></msqrt></mrow><annotation encoding="application/x-tex">2\sqrt{-2\sigma^2 \ln(\sqrt{2\sigma^2\pi}(1-\sqrt[N]{1-\gamma}))}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.84em;vertical-align:-0.444723em;"></span><span class="mord">2</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.395277em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">−</span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.003929em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.9639290000000003em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.036070999999999964em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7483150000000002em;"><span style="top:-2.90665em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9588750000000001em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.9188750000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.28112499999999985em;"><span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-3.355277em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em;"><svg width='400em' height='1.8800000000000001em' viewBox='0 0 400000 1944' preserveAspectRatio='xMinYMin slice'><path d='M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.444723em;"><span></span></span></span></span></span></span></span></span></span>
<h2 id="Application_to_the_Binomial">3. Application to the Binomial <a href="#Application_to_the_Binomial" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>The PDF of a binomial distribution <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">B</mi><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(x) = \mathcal{B}(m, p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.03041em;">B</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span>,
the probability of a number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> of positive events
among <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">m</span></span></span></span> events with probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span> of positivity,
follows this equation:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">(</mo><mfrac linethickness="0px"><mi>m</mi><mi>x</mi></mfrac><mo fence="true">)</mo></mrow><msup><mi>p</mi><mi>x</mi></msup><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mrow><mi>m</mi><mo>−</mo><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\varphi(x) = {m \choose x} p^x (1-p)^{m-x}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="mord"><span class="mord"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3.6769999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.071331em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.821331em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span>
<p>While <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> is a discrete integer,
the distribution of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">φ</span></span></span></span> is also is bell-shaped.
Thus the generic derivation above can also be applied.</p>
<p>Two issues arise when using that derivation, however:</p>
<ul>
<li>Unlike the Normal, the binomial coefficient cannot be elegantly <strong>inverted</strong>,
which prevents us from producing an exact formula.</li>
<li>For large values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>−</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">m - x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> (around <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup></mrow><annotation encoding="application/x-tex">2^{128}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span>),
calculating that binomial coefficient exactly
is <strong>too computationally expensive</strong> to yield a result within a lifetime.</li>
</ul>
<p>We can however devise an algorithmic method
by which we obtain an exact answer regardless.</p>
<p>The first issue can be solved by computing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> for all values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>
until the bell curve plummets back below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mroot><mrow><mn>1</mn><mo>−</mo><mi>γ</mi></mrow><mi>N</mi></mroot></mrow><annotation encoding="application/x-tex">1-\sqrt[N]{1-\gamma}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.22999999999999987em;"></span><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6896650000000002em;"><span style="top:-2.8480000000000003em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8100000000000002em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:-2.77em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.22999999999999987em;"><span></span></span></span></span></span></span></span></span>.
However, that method is impractical when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is too large.</p>
<p>Instead of going through each value of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>,
our algorithm can search for the right value
through increasingly accurate approximations,
similar to the way Newton’s method works.</p>
<p>This convergence works by:</p>
<ol>
<li>Using the best model we have of the distribution,</li>
<li>Gathering information from the estimated root,</li>
<li>Updating the model to be even more precise,</li>
<li>Iterating, similar to an interpolation search,
until eventually, we find two consecutive integers
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">x_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x_{max}+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> where the first is above the limit
(obtained from the generic derivation),
and the other is not.</li>
</ol>
<p>The two challenges in implementing this algorithm are:</p>
<ul>
<li>Problem 1: Evaluating <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> is too expensive for large <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span>
using integer arithmetic operations,</li>
<li>Problem 2: Establishing a good and computable model for the distribution,
and updating it in such a way that ensures eventual and fast convergence.</li>
</ul>
<h3 id="Evaluating_the_PDF">3.1. Evaluating the PDF <a href="#Evaluating_the_PDF" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>We use the classic solution:
first, convert the binomial coefficient formula to use the Gamma function.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac><msup><mi>p</mi><mi>x</mi></msup><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mrow><mi>m</mi><mo>−</mo><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\varphi(x) = \frac{\Gamma(m+1)}{\Gamma(x+1)\Gamma(m-x+1)} p^x (1-p)^{m-x}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">Γ</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Γ</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.071331em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.821331em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span>
<p>Then, to avoid handling large gamma results,
we rely on an exact computation of the log-gamma.
We can use an arbitrary-precision library
to ensure we get an error below the integer result we end up with.
(To find the right precision to set for the algorithm,
we can rely on exponential binary search.)</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>φ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mi>ln</mi><mo>⁡</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mi mathvariant="normal">Γ</mi><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>x</mi><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>x</mi><mo stretchy="false">)</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\varphi(x) = e^{
  \ln\Gamma(m+1) - \ln\Gamma(x+1) - \ln\Gamma(m-x+1)
  + x \ln(p) + (m-x) \ln(1-p)
}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">φ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.938em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight">Γ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight">Γ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight">Γ</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">x</span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mop mtight"><span class="mtight">l</span><span class="mtight">n</span></span><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">p</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>
<h3 id="Converging_to_the_range_extrema">3.2. Converging to the range extrema <a href="#Converging_to_the_range_extrema" class="autolink-clicker" aria-hidden="true">§</a></h3>
<script src="../assets/mean-range-of-a-bell-curve-distribution/mp-wasm.js"></script>
<script src="../assets/mean-range-of-a-bell-curve-distribution/normal-mean-range.js"></script>
<script src="../assets/mean-range-of-a-bell-curve-distribution/binomial-mean-range.js"></script>
<script>
fetchMPWasm('../assets/mean-range-of-a-bell-curve-distribution/mp.wasm')
.then(mpWasm => {
  const mpf = this.mpf = mpWasm.mpf;
  mpf.setDefaultPrec(256);
  const two256 = mpf(2).pow(256);
  const two128 = mpf(2).pow(128);
  const twom128 = mpf(2).pow(-128);
  const res128 = binomialRange(two128, twom128, two128);
  console.log(`min ${res128.min}`);
  console.log(`max ${res128.max}`);
  console.log(`range ${res128.range}`);
  const res256 = binomialRange(two256, twom128, two256);
  //console.log(`B(4,.5)(2) = ${binomialProb(2, 4, .5)}`);
  console.log(`min ${res256.min}`);
  console.log(`max ${res256.max}`);
  console.log(`range ${res256.range}`);
  //debugger;
});
</script>
<h2 id="Balls_Into_Bins">4. Balls Into Bins <a href="#Balls_Into_Bins" class="autolink-clicker" aria-hidden="true">§</a></h2>
<h2 id="Conclusion">Conclusion <a href="#Conclusion" class="autolink-clicker" aria-hidden="true">§</a></h2>
<script type="application/ld+json">
{ "@context": "http://schema.org",
  "@type": "BlogPosting",
  "datePublished": "2021-01-13T19:21:50Z",
  "keywords": "stats, crypto" }
</script> ]]>
        </content>
      </entry>
      <entry>
        <id>https://espadrine.github.io/blog/posts/nato-phonetic-alphabet.html</id>
        <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/posts/nato-phonetic-alphabet.html"/>
        <title>A Learning Resource for the NATO Phonetic Alphabet</title>
        <published>2020-11-11T19:18:25Z</published>
        <category term="codes"/>
        <content type="html">
          <![CDATA[ <h1 id="A_Learning_Resource_for_the_NATO_Phonetic_Alphabet">A Learning Resource for the NATO Phonetic Alphabet <a href="#A_Learning_Resource_for_the_NATO_Phonetic_Alphabet" class="autolink-clicker" aria-hidden="true">§</a></h1>
<iframe src=https://espadrine.github.io/nato-alphabet/
  style='width:100%; height:1000px; border:0'></iframe>
<p>A while back, I wrote <a href="https://espadrine.github.io/nato-alphabet/">a resource</a>
to help me learn the <a href="https://www.nato.int/cps/en/natohq/declassified_136216.htm">NATO phonetic alphabet</a>.</p>
<p><em>(Link to <a href="https://espadrine.github.io/nato-alphabet/">the full website here</a>.)</em></p>
<h2 id="What_does_this_resource_do_well_">What does this resource do well? <a href="#What_does_this_resource_do_well_" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>A major aspect of good learning, is the randomization of tests.</p>
<p>When you must remember by heart a large number of element,
a common mistake I find in schoolbooks
is for the exercises to repeat only the past ten new words or so.</p>
<p>It is critical, to achieve a leveled, continuous learning experience,
to randomly sample all words previously learnt,
regardless of how old.
That counteracts the inevitable forgetting of short-term-memory words.</p>
<p><em>If you can <strong>predict</strong> the words that your memory must remember,
you will subconsciously forget the words that won’t appear.</em>
Worse, you may link them to the predictable sequence of words
that the test is built on,
causing you to only remember one word when it is next to the other,
which in real life, it will often not be.</p>
<p>This principle is noticeably unfollowed in language manuals,
with predictable effects on my own learning.
I was (and am) frustrated to not have tools like these.</p>
<p>Good randomness is critical to healthy knowledge acquisition.</p>
<p>In fact, many machine learning systems heavily depend on that insight.
For instance, <a href="https://deepmind.com/blog/article/alphago-zero-starting-scratch">AlphaGo</a> carefully randomized the sequence of games
and the stage of the games that it had to learn,
to avoid the system from overfitting on one game, or on the late game.</p>
<h2 id="Why_did_I_want_to_learn_it_">Why did I want to learn it? <a href="#Why_did_I_want_to_learn_it_" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>When investigating production issues,
developers and operations managers often have to communicate identifiers
so they can share their findings.</p>
<blockquote>
<p>— “<em>Hey, take a look at payment authorization number
<code>78223a6b-6b41-41ac-9cc1-00b76a664ac9</code>:
the amount matches the settlement we are looking for.</em>”</p>
</blockquote>
<p><strong>Sequential identifiers</strong> are short (at first),
but betray information about when the entity was created,
which is often not welcome.
<em>Identifiers should never contain potentially secret information.</em></p>
<p><strong>Traditional UUID v4</strong> are not great at transmitting identifiers efficiently,
especially vocally.</p>
<p>Indeed, sequences of digits have a higher error rate when vocally transmitted.
They are easy to confuse with each other, after all;
using a larger glyph set increases distinguishability.</p>
<p><a href="https://qonto.com/en">At work</a>, we do have a lot of UUIDs.
In many spots in the deeper core of the system, however,
I opted for <strong>128-bit CSPRNG-produced base64 identifiers</strong>.
They are shorter (⌈128÷log2(64)⌉ = 22 characters)
and harder to mistype.</p>
<p>Looking back, one flaw with those is that it is very hard
to communicate them vocally.
You always end up having to specify uppercase / lowercase.
Even when mentally copying these IDs on your own,
you often use the wrong case.</p>
<p>Instead, <strong>base32</strong> does away with case,
making it very suitable for vocal transmission.
When lowercase, it is even particularly easy to read.</p>
<p>I must not be the only one with that opinion.
In fact, in the Bitcoin world,
the account number format has been switched from a base58 one,
to the new <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">Bech32</a> addresses introduced with SegWit.
Behold, it uses lowercase base32!</p>
<blockquote>
<p><code>bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4</code></p>
</blockquote>
<p>Of course, Bitcoin addresses are still very long.
Too long to transmit in a single breath.</p>
<p>We could constrain ourselves to 128 random bits,
yielding a ⌈128÷log2(32)⌉ = 26-character identifier.
As long as the entire alphabet!</p>
<p>There is a shorter technique:</p>
<ol>
<li>Identifier generator nodes are globally assigned a random 16-bit number.</li>
<li>They all share a 128-bit secret.</li>
<li>They each have a separate 48-bit counter that they increment for each new ID.</li>
<li>Each new identifier is <code>PRP((nodeID &lt;&lt; 48) ^ counter, secret)</code>,
where PRP is a 64-bit block cipher, like <a href="https://nsacyber.github.io/simon-speck/">Speck64/128</a> or XTEA.</li>
</ol>
<p>Since a block cipher is a <a href="https://en.wikipedia.org/wiki/Pseudorandom_permutation">Pseudo-Random Permutation</a> (or PRP for short),
it will cycle through all 64-bit values without repetition.
The output will be essentially indistinguishably random,
avoiding leaking information about the identified object.
And a 64-bit number is only 13 characters of base32!</p>
<blockquote>
<p>— “<em>Hey, take a look at payment authorization number <code>nhimasuge7f52</code>:
the amount matches the settlement we are looking for.</em>”</p>
</blockquote>
<p>That, finally, can be easily transmitted using the NATO system.</p>
<p><em>(This system is likely overkill, but a fun thought.)</em></p>
<hr />
<p><em><a href="https://www.reddit.com/r/espadrine/comments/jydh6k/a_learning_resource_for_the_nato_phonetic_alphabet/">Click to comment.</a></em></p>
<script type="application/ld+json">
{ "@context": "http://schema.org",
  "@type": "BlogPosting",
  "datePublished": "2020-11-11T19:18:25Z",
  "keywords": "codes" }
</script> ]]>
        </content>
      </entry>
      <entry>
        <id>https://espadrine.github.io/blog/posts/webidentity.html</id>
        <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/posts/webidentity.html"/>
        <title>WebIdentity: One-click passwordless signups &amp; logins</title>
        <published>2020-07-05T20:19:02Z</published>
        <category term="crypto"/>
<category term="web"/>
        <content type="html">
          <![CDATA[ <h1 id="WebIdentity_One_click_passwordless_signups_logins">WebIdentity: One-click passwordless signups &amp; logins <a href="#WebIdentity_One_click_passwordless_signups_logins" class="autolink-clicker" aria-hidden="true">§</a></h1>
<p>I talked about <a href="https://espadrine.github.io/blog/posts/memorable-passwords.html">best-practices for password-based logins last time</a>,
and gave tools to help you follow them.</p>
<p>Password managers (and generators) must become prevalent.
Thankfully, it is becoming a reality: beyond services such as 1password or Dashlane,
browsers themselves now offer those features built-in.
It sprouted from the bookmark sync feature, became password sync,
and now has suggested random passwords.</p>
<p>But <strong>passwords are inherently flawed</strong> as a security user experience.
Honestly, they slow down both registration to a new service, and logins.
It annoys users, allows terrible security practices, and
loses businesses billions yearly, both on users that give up,
and reputation from security issues.</p>
<p>There is a high cost to websites to implement and maintain security practices
around password storage.
By the way, this is the most significant example of “roll your own crypto”,
as each website defines its own authentication protocol.</p>
<p>There is also a cost for browsers: maintaining a list of passwords,
one for each website, makes for a fairly large total storage.
A significant, pernicious consequence is the emergence of siloes,
encouraging browser monopolies:
why would I switch browsers, when it is so hard to copy all those passwords over?</p>
<p>My hope for the future of authentication:</p>
<ul>
<li>Become so seamless that <strong>both signing up and logging in is a single click</strong>.</li>
<li>We want that improved UX, not just with the same security level that we have now, but a much better one.
<ul>
<li>An attacker that got its hands on a fresh plaintext copy of the website’s database and secrets should be unable to authenticate on behalf of users.</li>
<li>Even if someone can decrypt traffic on-the-fly, from seeing the authentication information, they also can’t impersonate the user for more than 30 seconds afterwards.</li>
<li>Even with both a full-on breach of the website’s servers <em>and</em> on-the-fly traffic decryption, they cannot sign up nor log in as you.</li>
</ul>
</li>
<li>And, cherry on top, we want to do so in such a way that <em>exporting identities between browsers and devices is extremely easy</em>.</li>
</ul>
<p>I called this new scheme <strong>WebIdentity</strong>.</p>
<h2 id="The_place_of_WebAuthn">The place of WebAuthn <a href="#The_place_of_WebAuthn" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Your mind may be itching to yell: “WebAuthn!”
So, before digging into the gritty details of WebIdentity,
let’s talk about the awesomeness that is WebAuthn.</p>
<p><a href="https://webauthn.guide/">WebAuthn</a> is an authentication scheme that relies on public-key cryptography.</p>
<p>A phenomenal advantage of WebAuthn over WebIdentity is
in the ability to leverage a wide range of different security devices
(Yubico, TouchID, Windows Hello, and so many more).
In short, it is <em>absolutely amazing</em> at second-factor authentication (2FA),
which is completely outside the scope of WebIdentity and would complement it beautifully.</p>
<p>However, WebAuthn has severe disadvantages for use as main authentication,
which WebIdentity solves wonderfully.
Betting on WebAuthn as the main sign-up and log-in system
risks significantly delaying the wide adoption
of passwordless authentication on the Web:</p>
<ul>
<li>Websites do not implement it because:
<ul>
<li>on the backend, it requires them to implement a PKI, which is an endeavor.
Multiple public keys can map to the same user, and management of the keys
(and of the certificate validation upon sign-up, when necessary) needs proper handling.</li>
<li>on the front-end, it requires subtle cryptography to handle the challenge handshake,
that needs to be implemented not just for the Web, but for iOS and Android apps.
With WebIdentity, there is no front-end change at all.</li>
</ul>
</li>
<li><strong>Feature detection</strong> is involved. Both the front-end and the backend must know
that the user can do WebAuthn on that device, and ideally, the backend stores it
on secure httpOnly cookies. It also must store the list of credential IDs:
there could be multiple users on the same device.
WebIdentity relies on the user management feature already built into the browser’s Sync.</li>
<li>For websites, it requires a <strong>database access</strong> for each authentication.
That contributes to a requirement to only use WebAuthn for login, not session authentication.
WebIdentity does both in one fell swoop, and database interaction is only needed for sign-ups and logins.</li>
<li>More damningly, the protocol requires a back-and-forth;
in other words, it cannot be used directly for all HTTP requests.
It needs a separate, <strong>unspecified session key management scheme</strong> such as JWT.
With WebIdentity, the user authentication scheme is indistinguishable from
the session authentication scheme.</li>
<li>Most damningly, <strong>exporting the public/private key pairs between browsers</strong> was not part of the design process.
In fact, synchronizing those keys (some of which can change) between browsers is a complex operation.
It goes so far that the <a href="https://developer.apple.com/videos/play/wwdc2020/10670/">official recommendation from browser makers</a> is to never have WebAuthn log-in
be the only log-in mechanism, because private keys are tied to the device.
Changing (or losing) devices require logging in through another means.
Thus, it is only a faster log-in process (click login, select identity, accept request, enter biometrics or press Yubikey button)
than passwords, but passwords remain the main log-in weak link that won’t die.
Meanwhile, WebIdentity has a faster log-in still (there is literally just the click login step),
and can fully replace passwords.</li>
<li>To roll it out slowly, it started being <strong>used only as 2FA</strong>.
It is now usually tied to things like Yubikey in the UX,
and seems doomed to remain only used for 2FA,
as a consequence of everything listed above.</li>
<li>WebAuthn suffers from <strong>crypto-agility</strong>, similar to JWT where it caused security faults.
In WebIdentity, algorithms are set for each version,
and version changes are only performed when the previous algorithm is broken.
Since there is really only one cryptographic algorithm, it is easy to keep track of.</li>
<li>In the same vein, it is easy for a service operator to <strong>misuse</strong> WebAuthn,
and end up losing major security protections. There are many subtle traps.
For instance, they may generate challenges with a poor random source,
or forget to validate some metadata field received.</li>
<li>Where is the <strong>NFC antenna</strong> on this phone?</li>
<li>Public-key cryptography is currently at risk from <strong>quantum computing</strong> advances,
whereas WebIdentity relies on primitives that are essentially <a href="https://en.wikipedia.org/wiki/SHA-3#Security_against_quantum_attacks">quantum-resistant</a>.</li>
</ul>
<p>All in all, WebAuthn is harder for website operators to put in place than passwords,
while WebIdentity is simpler.
(Although they would only do so once all major evergreen browsers implement it.)</p>
<p>The status quo: despite browsers’ efforts to add support not just for Yubikeys but also TouchID,
website owners are very shy in implementing support even just for 2FA,
in part because of the implementation complexity,
and the user experience is frustrating enough currently that few actually use it.
I do not know any independent commercial website
that uses WebAuthn as its primary log-in system, instead of passwords.</p>
<p>WebIdentity can quickly replace password authentication with a much simpler system,
both for users, website operators, and browsers;
while WebAuthn is likely to have a slow, 10-year adoption across websites.</p>
<p>However, WebIdentity does not replace WebAuthn!
WebAuthn is still extremely valuable as 2FA,
which should really be used on all sensitive actions on the website.</p>
<h2 id="Initialization">Initialization <a href="#Initialization" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>First, the browser stores a single random 256-bit secret for each user,
called the <strong>Browser Key (BK)</strong>,
synchronized across all devices through its Sync feature.
That key never leaves the browser’s Sync servers.</p>
<p>Each website keeps around a random 256-bit secret key (<strong>Website Key, WK</strong>)
identified by a <strong>key ID (KID)</strong>,
typically a number incremented every time the key needs to change,
which should be rare, eg. yearly.
It must be generated by a CSPRNG, for instance from /dev/urandom.</p>
<h2 id="Sign_Up">Sign-Up <a href="#Sign_Up" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>When going on a page, the website advertizes that it supports WebIdentity
by delivering this header (even on 200 status results):</p>
<pre><code>WWW-Authenticate: Identity v1
</code></pre>
<p>Upon seeing it, the browser displays a “Log in” button <em>in its chrome</em>
(above the <a href="https://textslashplain.com/2017/01/14/the-line-of-death/">line of death</a>, thus not in the webpage),
if the website uses TLS and HSTS.</p>
<p>When the user clicks it, from then on, for all HTTPS requests to that website,
the browser will authenticate the user to the website,
and display a “Log out” button instead of the “Log in” one.</p>
<p>But first, there is a tiny sign-up handshake.
First, the browser computes the <strong>User’s Website Key (UWK)</strong> as the MAC
of the effective Top-Level Domain <a href="https://publicsuffix.org/">eTLD+1</a>:
it is unique for each entity that has control over a given cookie space,
and incidentally will also soon be <a href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/url_display_guidelines/url_display_guidelines.md#registrabledomain">the only URL part shown</a> (to fight phishing).
So the security UX will be consistent for identity and website trust here.
The UWK MAC is keyed with BK, the user’s Sync secret kept by the browser.
The UWK is a <em>secret that the browser has for each user and each website</em>.
It is never stored and only transmitted between the browser’s Sync servers
and the user’s browser upon sign-up and login.</p>
<p>Then, the browser takes a MAC of the ASCII string “AUID”, keyed with UWK:
this becomes the <strong>Authentication User ID (AUID)</strong>
which will <em>identify the user in each HTTP request</em>.
Eavesdropper cannot find the UWK from it, which is good,
since it is only used for very rare, sensitive operations.</p>
<p>Finally, the browser picks a <strong>Log-In Date (LID)</strong> to send as an HTTP header,
and computes its MAC, keyed with the User’s Website Key (UWK).
The result is the <strong>Log-In Proof token (LIP)</strong>,
a piece of information kept secret by the browser,
which will be later revealed to the website when logging back in,
to strongly prove that the initiator is the initial user.</p>
<p>Aside: as you can imagine, there will be a whole tree of hashes,
each with a different purpose and name.
To help you follow along, here is a picture of the entire tree:</p>
<p><img src="../assets/webidentity/webidentity-hash-tree.svg" alt="WebIdentity hash tree" /></p>
<p>The browser reloads the page with the Date header set to the LID,
and the following new header
(all in one line, with spaces instead of newlines; the newlines are for readability):</p>
<pre><code>Authorization: Identity v1 SignUp
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  liv=&quot;7deoyUWH9wk-x15mb-vr7i57rU0VojDLwc99EjtKUlUK&quot;
</code></pre>
<ul>
<li><code>Identity</code> indicates that it uses this authorization scheme.</li>
<li><code>v1</code> is the version of the scheme; it likely would change very rarely, typically when the hash function gets broken.</li>
<li><code>SignUp</code> is the action: here, we sign up as a new user.</li>
<li><code>VzX3…</code> is the Authentication User ID (AUID), which the website will rely on to identify the user.</li>
<li><code>7deo…</code> is the <strong>Log-In Verification token (LIV)</strong>,
a MAC of the AUID keyed with the Log-In Proof token (LIP).</li>
<li>The LID is sent in the Date header so that the website can store it.</li>
</ul>
<p>The website cannot guess the LIP, nor can any eavesdropper,
which is good, since the LIP will be used to prove knowledge of BK
for rare, sensitive updates.</p>
<p>The website identifies the user from the AUID (indirectly),
but it cannot guess the user’s AUID for another website.
Besides, two websites cannot know that their respective AUIDs correspond to the same user
without seriously endangering the security of their own authentication.
That protects the user’s privacy across websites.</p>
<p>Upon receiving a SignUp request,
the website takes a MAC of the AUID, keyed with WK (the website’s secret key).
That is the <strong>Website’s User Key (WUK)</strong>, a secret kept by the website, unique to a user.
It is roughly the opposite of the User’s Website Key (UWK).
The user cannot know the website’s other users’ WUK,
since it would need both their BK and the WK to do so.</p>
<p>Then, the website computes the <strong>User ID (UID)</strong> as the MAC of the AUID
keyed with its Website’s User Key (WUK).
The UID will be stored in database, etc.
Intruders cannot find the AUID nor the WUK from read-only access to the database,
preventing them from crafting fake authenticated requests.</p>
<p>Then it does the following:</p>
<ol>
<li>It verifies that the LID is within one minute of its known date. If not, the sign-up is denied.</li>
<li>It stores in database the UID, the LID, and the LIV, likely with a mapping to its internal user identifier.
In our example, the UID is <code>XvP5sxmrh8UmpgYqJ9OmKs9HqhxcdS5-lUxlaEuhBc4</code>.</li>
</ol>
<p>Then, the website prepares a response.</p>
<p>First, it constructs the <strong>Log-In Shared Key (LISK)</strong>
as the MAC of the Log-In Date (LID) keyed with the Website’s User Key (WUK).
That key will be <em>shared between the website and the browser</em> for one hour,
and will be used to compute a TOTP.</p>
<p>If the website sees that the user was already signed up,
it will accept it, but with slight differences in the response
that are discussed in the Log In section.
Otherwise, it returns a page with the following header:</p>
<pre><code>WWW-Authenticate: Identity v1 Key
  kid=&quot;2020&quot;
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  lisk=&quot;Ii6JLfnbWJgcy0WtworWKRIlJIPSGkQwSAvBtQM1OEgK&quot;
</code></pre>
<ul>
<li><code>Key</code> is the action instructing the browser to store the website’s key.</li>
<li><code>2020</code> is the KID, placed first to ease inspection.</li>
<li><code>VzX3…</code> is the AUID, identifying the user in all future requests.</li>
<li><code>Ii6J…</code> is the LISK, which will be used to prove that the user is who they claim to be for one hour.</li>
</ul>
<p>(The website can also send identifying data,
such as its internal ID (eg. a username or its database’s generated <code>user_id</code>),
in a payload encrypted with the WUK as key,
in the Cookies header, ideally Secure and httpOnly.
That lets it avoid a database fetch when it relies on an internally-produced ID
instead of the UID provided by WebIdentity.
That part is outside the definition of WebIdentity, however.)</p>
<p>The browser stores the version (v1), the KID, the LID and the LISK in its Sync feature.</p>
<h2 id="Authentication">Authentication <a href="#Authentication" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>On each HTTP request while logged in, the browser sends the AUID,
along with a MAC of the Date HTTP header keyed with the LISK:</p>
<pre><code>Authorization: Identity v1 Auth
  kid=&quot;2020&quot;
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  lid=&quot;Fri, 03 Jul 2020 10:11:22 GMT&quot;
  totp=&quot;YrrliECBpS34lKob4xMOIKgM5zw8_zxMsBBleIIfGHIK&quot;
</code></pre>
<ul>
<li><code>Auth</code> is the action to authenticate the request.</li>
<li><code>2020</code> is the KID in use.</li>
<li><code>VzX3…</code> is the AUID, as returned from the SignUp response.</li>
<li>The Log-In Date (LID) lets the website compute the LISK.</li>
<li><code>Yrrl…</code> is the <strong>Time-based One-Time Password (TOTP)</strong>:
the MAC of the Date (<code>Fri, 03 Jul 2020 14:32:19 GMT</code>), keyed with the LISK.</li>
</ul>
<p>When receiving an Auth request, the website must:</p>
<ol>
<li>Verify that the Date sent is within one minute of the accurate date. The request is denied otherwise.</li>
<li>Verify that the Log-In Date (LID) is not more than one hour old.
The request is denied otherwise: the browser always knows to make a LogIn request (seen below) instead.
(Note that it does not matter if the LID does not match the stored LID.
That way, multiple browsers can share the same BK and still authenticate in parallel.)</li>
<li>Compute the MAC of the request’s AUID, keyed with the WK. That is the WUK.</li>
<li>Compute the MAC of the LID, keyed with the WUK. That is the LISK.</li>
<li>Compute the MAC of the Date, keyed with the LISK. Verify that it matches the TOTP. The request is denied otherwise.</li>
<li>Compute the MAC of the request’s AUID, keyed with the WUK: that is the UID, which can be used for application purposes.</li>
</ol>
<p>Note that this computation does not require database access, and is quite efficient in software.</p>
<p>The explanation of the main principle of operation is already finished.
Let’s look at a few events that may occur,
ranging in order from uncommon (monthly?) to extremely rare (every 20 years?).</p>
<h3 id="Log_Out">Log Out <a href="#Log_Out" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>When logged in, the browser’s Log In button changes to a Log out button.</p>
<p>When clicking the Log out button,
the browser deletes the protocol version, KID, AUID and LISK in Sync;
and no longer sends Authorization headers.</p>
<p>The browser logs out and logs back in automatically every hour,
to ensure it does not use the same LISK for too long.
Because of the way log-outs and log-ins work,
this is entirely seamless and invisible to the user.</p>
<h3 id="Log_In">Log In <a href="#Log_In" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>When the browser tries to log in, in fact, it starts by simply doing the sign-up procedure.</p>
<p>The website detects that a sign-up already occured, and initiates the login procedure:</p>
<pre><code>WWW-Authenticate: Identity v1 LogIn
  lid=&quot;Fri, 03 Jul 2020 10:11:22 GMT&quot;
</code></pre>
<p>You can find after the LogIn keyword, the Log-In Date (LID) that the website registered for this UID.</p>
<p>The browser’s Sync server computes the User’s Website Key
(UWK, a MAC of the eTLD+1 keyed with BK),
and keys with it a MAC of that LID.
That gives it the Log-In Proof (LIP) that was created during sign-up.</p>
<p>Just as with a normal sign-up,
the browser picks a new <strong>Log-In Date (LID)</strong> to send as an HTTP header,
and computes its MAC, keyed with the User’s Website Key (UWK).
The result is a brand-new <strong>Log-In Proof (LIP)</strong>.
(In our example, the new LID is <code>Fri, 03 Jul 2020 15:27:43 GMT</code>.)</p>
<p>It then sends a LogIn request,
which is essentially identical to the SignUp request, but with the new LIV:</p>
<pre><code>Authorization: Identity v1 LogIn
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  olip=&quot;8x8HgKzEl5nok-JNwT2PCiwnfwrCD2rOxtMTUotU4hgK&quot;
  liv=&quot;S4GFp0Xh8rSeV9-VgpNTCW2iDPd36sABZrGPqwj8oJkK&quot;
</code></pre>
<ul>
<li><code>VzX3…</code> is the Authentication User ID (AUID).</li>
<li><code>8x8H…</code> is the old Log-In Proof (LIP).</li>
<li><code>S4GF…</code>, is a new <strong>Log-In Verification token (LIV)</strong>,
a MAC of the AUID keyed with the Log-In Proof (LIP).</li>
<li>The LID is sent in the Date header, so that the website can store it.</li>
</ul>
<p>The website constructs the WUK as the MAC of the AUID keyed with its WK,
and gets the UID as the MAC of the AUID keyed with the WUK.
Then it validates the following:</p>
<ol>
<li>The LID must be within one minute of its known date.</li>
<li>The old LIV must be the one associated with this UID as stored in database.</li>
<li>Computing the MAC of the AUID keyed with the old LIP transmitted in the request,
yields the old LIV stored in database.</li>
</ol>
<p>If the validation fails, the LogIn request is denied.
Then, if both validated OK, it updates in database the sign-up Date and the new LIV.</p>
<p>You may notice that neither the website,
nor any eavesdropper with full read access to the website,
could guess the LIP until they see it in the Log In request.
Thus, they could not perform a Log In request;
and when they see it in the HTTPS payload, it is too late to take advantage of it,
as the LIV is updated with a new one for which they don’t have the LIP.</p>
<p>The rest goes exactly like a Sign Up:</p>
<pre><code>WWW-Authenticate: Identity v1 Key
  kid=&quot;2020&quot;
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  lisk=&quot;zhgoQXVsATIUd-S2mB1gUlKi5yj_iO7K7KrsI_H8rBEK&quot;
</code></pre>
<ul>
<li><code>Key</code> is the action instructing the browser to store the website’s key.</li>
<li><code>2020</code> is the KID, placed first to ease inspection.</li>
<li><code>VzX3…</code> is the AUID, identifying the user in all future requests.</li>
<li><code>zhgo…</code> is the Log-In Shared Key (LISK), which will be used to prove that the user is who they claim to be.</li>
</ul>
<p>The browser stores the version (v1), the KID, the new LID and the LISK in its Sync feature.</p>
<h3 id="Website_key_update">Website key update <a href="#Website_key_update" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>If the website worries its key may be compromised, it will rekey.
However, it must keep all past keys, and accept all of them,
so that users can authenticate even years after the last request.</p>
<p>(The main point of rekeying is to migrate users to a key
that is not compromised, such that they don’t run the risk of being
impersonated if the website has futher severe security failures.)</p>
<p>Once rekeyed, when the website receives an Auth request with an old key,
it authenticates the request with the corresponding key and accepts the request,
but responds with a new Key action, similar to a sign-up:</p>
<pre><code>WWW-Authenticate: Identity v1 Key
  kid=&quot;2021&quot;
  auid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  lisk=&quot;zhgoQXVsATIUd-S2mB1gUlKi5yj_iO7K7KrsI_H8rBEK&quot;
</code></pre>
<p>When receiving this, the browser updates its KID and LISK in its Sync storage for the website.
It then uses the new LISK on future authentications.</p>
<p>As long as the website only performs the rekeying after they regained full access
and ensured that their TLS connections were not (or no longer) compromised,
this sensitive transmission of a LISK should not be eavesdropped.
After rekeying, they can therefore safely communicate to all customers
the need to log out and log back in.</p>
<h3 id="Browser_export">Browser export <a href="#Browser_export" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>Browsers must provide a way to export the Browser Key to another browser.
It is recommended that the browser export format be encrypted with the user’s master password.
Additionally, any export event should be authenticated with a second factor.</p>
<p>From just the BK, the new browser can perform the Log In procedure on all websites.</p>
<h3 id="Account_takeover_or_Browser_Sync_breach">Account takeover or Browser Sync breach <a href="#Account_takeover_or_Browser_Sync_breach" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>When a user’s BK is leaked, the website owner (if customer service detects an account takeover)
or browser (in the case of a breach of their Sync service)
will instruct the user to trigger the <strong>Browser Key Reset procedure</strong>.</p>
<p>The browser must have a button in its UI (for instance, in the Sync Preferences page) triggering the procedure:</p>
<p>First, it will create a new BK (say, <code>0dP_ocrzSwieAuLUNCD6P660HLLOGl9zyfxYwdSLI0kK</code>),
but keep the old BK around.</p>
<p>Then, for each website for which the user has a LISK associated to the old BK,
the browser will make a ReSignUp request, very similar to a LogIn request:</p>
<pre><code>Authorization: Identity v1 ReSignUp v1
  oauid=&quot;VzX3h8VumdWIY7MiUCcYwnS8kz9DxdtFzQftFhLvkFkK&quot;
  olip=&quot;R05PEuFZHCngevxsxJZsIDeJe66IDGYqoH3JBVtT-DcK&quot;
  auid=&quot;yFvfOjHW68qyhMIPobZdL6oZmIIOD7aEVquwkkbbxS4&quot;
  liv=&quot;yWPeXDGFi3q8ZAwVOAvbv5swl6oVoOScw7Y3CDVPQCM&quot;
</code></pre>
<ul>
<li><code>ReSignUp</code> is a new action to instruct the website to reset the UIDs everywhere where it matters, and provide a new LISK.</li>
<li><code>v1</code> means that the protocol used for the old IDs and tokens is v1. This is useful for the “Hash function theoretically broken” section.</li>
<li><code>VzX3…</code> is the old Authentication User ID (AUID).</li>
<li><code>R05P…</code> is the old Log-In Proof (LIP).</li>
<li><code>yFvf…</code> is a new Authentication User ID (AUID).</li>
<li><code>yWPe…</code>, is a new Log-In Verification token (LIV),
a MAC of the new AUID keyed with the new Log-In Proof (LIP).</li>
<li>The new LID is sent in the Date header (<code>Fri, 03 Jul 2020 16:03:26 GMT</code>).</li>
</ul>
<p>The website treats it just like a LogIn request, except it also updates the UID in database.</p>
<p>A Browser Sync breach would obviously be a major event.
In the old password world, it is equivalent to
having the worldwide Google Chrome passwords leaked. It would cause all Chrome users
to need to reset their passwords one by one on every website.</p>
<p>Thankfully, with WebIdentity, this can be automated by the browser seamlessly.</p>
<p>First, the browser will need to close the breach.
Then, for each user, it will automatically trigger the Browser Key Reset procedure remotely.</p>
<p>Obviously, just as with a Google Chrome password leak,
adversaries could take control of user accounts by doing a ReSignUp on their behalf.
WebIdentity is better in this respect: the browsers can automatically update information,
leaving a small window for attackers to take over accounts;
while a password leak may have users that take years to update a given password.</p>
<p>Just as with passwords, it is recommended that browsers implement Sync
in such a way that the user decypts Sync secrets on their machine
through the use of a master password.
As a result, the Sync servers would only contain encrypted data without the key.
Obviously, even a leak of the mere encrypted data should trigger a ReSignUp,
but at least the risk of user account takeover would be greatly reduced.</p>
<h3 id="Hash_function_theoretically_broken">Hash function theoretically broken <a href="#Hash_function_theoretically_broken" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>It took ten years from SHA-1 publication to full-round collisions.
While SHA-2 has already survived twenty,
it is plausible that it gets eventually broken theoretically.
That was the motivation for the SHA-3 process,
which yielded a primitive seemingly likely to take even more time
than SHA-2 to get broken, thanks to its sponge construction.</p>
<p>When SHA-2 gets theoretically broken,
we will release v2 of the protocol.
Browser vendors and website operators will need to implement it
before it gets practically broken
(which for SHA-1 took ten years).</p>
<p>Websites supporting v2 must also support v1 for at least ten years,
which ought to be enough time for browser vendors to implement v2.</p>
<p>When browsers only support v1, and see support for v2 from a website,
they must send v1 requests, and the website must follow the v1 protocol.</p>
<p>When browsers implement v2 and hold a v1 authentication AUID/LISK,
they must follow the Browser Key Reset procedure.</p>
<h3 id="Threat_models">Threat models <a href="#Threat_models" class="autolink-clicker" aria-hidden="true">§</a></h3>
<ul>
<li>Website attack:
<ul>
<li>From a third party:
<ul>
<li><strong>Replay attack</strong>: If they replay the encrypted request of an authenticated user within the 30-second window, they may trigger the corresponding action (eg. a bank transfer) twice. We recommend that websites implement idempotency checks, as this could also happen from network glitches.</li>
<li>If they get <strong>read access to the website</strong> database, the UID gives no information that can be used to authenticate on behalf of the user.</li>
<li>If they also compromise WK, the <strong>website key</strong>, they still lack the AUID (which is not stored) to be able to do anything.</li>
<li>If they compromise the <strong>website’s TLS encryption</strong>, such as with the <a href="https://blog.cloudflare.com/incident-report-on-memory-leak-caused-by-cloudflare-parser-bug/">CloudFlare memory leak</a>, they can read the encrypted payloads between the user and the website.
<ul>
<li>Reading the requests gives them a valid AUID/LID/TOTP set, but they only have a 30-second window (1 minute in rare worst-case clock drifts) to perform authenticated requests on behalf of the user, as they lack the LISK to be able to MAC new dates. They cannot issue a LogIn or ReSignUp request, lacking the LIP; and this remains true even if they additionally compromise the WK and database. Securitywise, this is a significant improvement compared to JWT, PASETO and similar session token approaches, which typically have anywhere from 5 minutes (for access tokens) to months of lifetime (for refresh tokens). An attacker reading a JWT refresh token in the encrypted payloads can typically use it to get unlimited access tokens for weeks if not ever. By contrast, with WebIdentity, the longest this attacker would be able to make authenticated queries is a minute, but usually half that (as most clients will not have much clock drift).</li>
<li>They can also read SignUp requests, although those will be rarer. The response includes the LISK, letting them fabricate valid TOTPs past 30 seconds. However, it will be invalidated through automatic logout after up to one hour. LISKs older than one hour will be useless to an attacker. On the other hand, if they can read the TLS traffic on-the-fly, they can view the new LISKs. As long as they maintain this ability, they can authenticate on behalf of the user. The flaw must be fixed by the website, and all LIDs invalidated, forcing a re-login.</li>
</ul>
</li>
<li>If they compromise both the <strong>website’s TLS encryption and its WK</strong>:
<ul>
<li>For each AUID/LID/TOTP they see in the encrypted traffic, if the LID is still valid, they can derive the current LISK, and with it, perform authenticated requests for up to one hour (after which the automatic logout will prevent that).</li>
<li>Similarly, they can get the LISK from SignUps and LogIns. If they can read the traffic on-the-fly, they can see the new LISKs produced even after the one-hour logout. Again, the solution is to fix the flaw and invalidate the LIDs.</li>
</ul>
</li>
</ul>
</li>
<li>From <strong>another website</strong>: knowledge of that website’s AUID is insufficient to guess other websites’ AUID (that requires knowing the BK), let alone the LISK (which requires that website’s WK).</li>
<li>From the <strong>user</strong>: knowledge of the LISK is insufficient to guess WK, the Website Key, and therefore, to make authenticated requests on behalf of other users of the website. Additionally, even if they could, knowledge of other users’ AUID would be necessary, which requires knowing their BK.</li>
<li>From the <strong>browser</strong>: since it has access to the Sync secrets, it can perform authenticated requests and account takeover for all its registered users. However, it cannot do so for users of other browsers, if their BK is not explicitly shared.</li>
</ul>
</li>
<li>Browser attack:
<ul>
<li><strong>XSS</strong>: Since WebIdentity is controlled by the browser and has no JS integration, JS code cannot access secrets or perform authentication. All the exchanges and headers related to WebIdentity must be hidden from the page transparently. All same-origin requests are authenticated or not depending on whether the user has clicked the Log In button, and depending on the <a href="https://fetch.spec.whatwg.org/#ref-for-concept-request-credentials-mode">credentials mode</a>. Cross-site requests comply with CORS. The Authorization and WWW-Authenticate headers already have the right protections in place.</li>
<li>Browsers should never have BK on the device. They can store the websites’ KID, AUID and LISK. An attacker that gains access to the <strong>device’s permanent or memory storage</strong> will be unable to obtain the BK, and therefore sign up on new websites. They can however make authenticated requests on behalf of the user to websites in which they are signed up, for up to one hour after they lose access. It is therefore necessary for browsers to encrypt the Sync database (with the LISK) if they cache it locally, which is already the case. They should not use an encryption key that is common to multiple users (also already the case IIUC).</li>
<li>The Operating System and the CPU, on the other hand, can obviously access the BK <strong>in memory</strong> and perform authenticated requests and account takeover on behalf of the user, but not of other users.</li>
<li><strong>BK loss</strong>: the Browser Sync could experience complete loss of data, including the BK, maliciously or accidentally. The consequence would be the same as a password manager, today, losing the passwords (which indeed is the main thing it wishes to guarantee as a business), or a website using WebAuthn as only primary authentication and the user losing their device (Yubico etc.): users would no longer be able to log in. However, people that switched browsers or backed up their BK would be able to add it back in using the <em>Browser Export</em> procedure.</li>
</ul>
</li>
</ul>
<h3 id="Cryptographic_comments">Cryptographic comments <a href="#Cryptographic_comments" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>The whole scheme is both extremely inexpensive and simple to implement both for websites and browsers,
especially compared to current techniques (which involve, for instance, the expensive Argon2 for passwords).
The payload weigh is marginal.</p>
<p>It also does not make use of public-key cryptography,
which protects it from the threat of quantum computing advances.
The main impact might be longer hashes, although even that is in question.</p>
<p>The protocol is versioned in such a way that there is no cryptographic algorithm agility,
in line with common practices such as <a href="https://github.com/FiloSottile/age">age</a> and <a href="https://paragonie.com/files/talks/NoWayJoseCPV2018.pdf">PASETO</a>.</p>
<p>The MAC algorithm for v1 of the protocol is HMAC-SHA256.</p>
<p>(I would love to put BLAKE3 here, but some websites will object to a non-NIST-approved primitive.
And SHA3 (with no HMAC!) would also be nice, I would love to argue for its use;
but it is true that some websites may have legacy and dependency constraints;
and unlike WebAuthn, the goal of WebIdentity is to quickly get very widespread adoption
as the primary authentication mechanism on the Web.)</p>
<p>All <a href="https://tools.ietf.org/html/rfc4648#section-5">base64url</a> inputs must be converted to a byte buffer prior to use.
The implementation should be constant-time.</p>
<p>The eTLD+1 must be in ASCII punycode form for use in WebIdentity (simplifying debugging).</p>
<h2 id="Vectors">Vectors <a href="#Vectors" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>The examples use:</p>
<ul>
<li>Website eTLD+1: <code>example.org</code>.</li>
<li>BK: <code>GVr2rsMpdVKNMYkIohdCLhOeHSBIL8KBjoCvleDbsJsK</code> (generated with <code>head -c 32 &lt;/dev/urandom | base64 | tr +/ -_</code>).</li>
<li>WK: <code>DCmk1xzu05QmT578_9QUSckIjCYRyr19W0bf0bMb46MK</code>.</li>
<li>MACs generated with <code>echo -n &quot;$input&quot; | openssl sha256 -hmac &quot;$key&quot; | cut -f2 -d' ' | xxd -r -p | base64 | tr +/ -_ | tr -d =</code>.</li>
</ul>
<p>The script to generate the examples is available <a href="https://github.com/espadrine/espadrine.github.com/blob/master/blog/assets/webidentity/test-vectors.sh">here</a>;
running it yields all values used in examples.</p>
<h2 id="Acknowledgements">Acknowledgements <a href="#Acknowledgements" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Thanks go to /u/josejimeniz2 for considering the risk of Sync data loss,
and to /u/haxelion for raising the risk of having the BK on the device
(which is no longer the case in the current draft).</p>
<h2 id="Comments_and_links">Comments and links <a href="#Comments_and_links" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p><a href="https://www.reddit.com/r/espadrine/comments/hlrx40/webidentity_oneclick_passwordless_signups_logins/">Blog comments here</a>.</p>
<script type="application/ld+json">
{ "@context": "http://schema.org",
  "@type": "BlogPosting",
  "datePublished": "2020-07-05T20:19:02Z",
  "keywords": "crypto, web" }
</script> ]]>
        </content>
      </entry>
      <entry>
        <id>https://espadrine.github.io/blog/posts/memorable-passwords.html</id>
        <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/posts/memorable-passwords.html"/>
        <title>Memorable passwords</title>
        <published>2020-06-24T19:50:27Z</published>
        <category term="crypto"/>
        <content type="html">
          <![CDATA[ <h1 id="Memorable_passwords">Memorable passwords <a href="#Memorable_passwords" class="autolink-clicker" aria-hidden="true">§</a></h1>
<p>We are slowly getting to a comfortable password situation.</p>
<p>Research has improved on which passwords are easier to remember.
Cryptographers have <a href="https://password-hashing.net/argon2-specs.pdf">strenghtened the cost</a> of cracking weak passwords.
People are more aware of the security risks,
and the usage of password managers grows.</p>
<p>The consensus on password handling is this:</p>
<ol>
<li>Keep a very strong master password in your head, stored nowhere.</li>
<li>Use it to unlock your password manager.</li>
<li>Use your password manager to store and create very random passwords for individual websites.
You would never be able to remember them, but you only need to remember the master password.
Typically, for alphanumerical outputs, you need ⌈128÷log2(26·2+10)⌉ = 22 characters.</li>
<li>The websites, and more importantly, the password manager,
use a key derivation function such as <a href="https://password-hashing.net/argon2-specs.pdf">Argon2</a> either on the front-end
(server relief) or on the backend, and only stores the output.
It ensures computation is both time-hard and memory-hard, with settings kept up-to-date
to ensure that each computation takes 0.5 seconds and/or 4 GB of RAM.</li>
</ol>
<p>But some details are left unset: exactly how strong should the master password be?
How do we even know?
Can this situation converge to an easier user experience for login on the Web?</p>
<h2 id="Password_hashing">Password hashing <a href="#Password_hashing" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Some accurate statements may be surprising to the general population.
This is one:</p>
<p><strong>Multiple passwords can unlock your account.</strong></p>
<p>The reason? Your password is not compared byte-for-byte (thankfully!)
but through a hashing method that does not map one-to-one.</p>
<p>Indeed, hashes have fixed sizes (typically 256 bits),
while passwords have arbitrary length.</p>
<p>Overall, this consideration is unimportant,
because virtually no password is strong enough
to even compete with the collision risk of the hash:
it is tremendously more likely for a collision to be caused by
the generation process, than by the hash,
whose collision risk is 2<sup>N÷2</sup>
where N is the size of the hash, typically 256 bits nowadays.</p>
<p>On top of this, some companies build their login system
in a way that is more resilient to user error,
such as <a href="https://www.zdnet.com/article/facebook-passwords-are-not-case-sensitive-update">having caps lock on</a>.</p>
<p>That too is irrelevant, since the search space is typically only reduced
by one bit (corresponding to the choice between setting caps lock or not).</p>
<h2 id="Target_strength">Target strength <a href="#Target_strength" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p><a href="https://crypto.stackexchange.com/questions/60815/recommended-minimum-entropy-for-online-passwords-in-2018">Some suggestions target specific cryptographic algorithms</a>.
But this pushes machine limits into human constraints:
algorithms require 128-bit security, not because 127 is not enough,
but because it is a power of two that neatly fits with various engineering techniques.</p>
<p>The real human constraint is your lifetime.
Once you are dead, it does not matter too much to your brain whether your secrets are out,
since your brain becomes mulch.</p>
<p>The longest person alive is a French woman that died nearly reaching 123.
Let’s imagine that health will improve
such that someone will live double that amount, Y = 246 years.
What is the minimum strength needed to ensure they won’t have their secrets cracked alive?</p>
<p>Current compute costs hover around €3/month on low-end machines.
Let’s imagine that it will improve a hundredfold in the coming century.</p>
<p>The NSA yearly budget is estimated at B = €10 billion.
Can they hack you before you die?</p>
<p>First, under those assumptions,
assuming the NSA consumes its whole budget cracking you,
how many computers will it use to crack you in parallel?
The result is P = B ÷ 12 ÷ 0.03 = 28 billion servers.</p>
<p>If your password has an N-bit entropy,
it will take 2<sup>N-1</sup>·0.005÷P÷3600÷24÷365 years on average,
assuming the NSA is brute-forcing with CPUs that can do one attempt every 5 milliseconds
(a hundredth of the <a href="https://password-hashing.net/argon2-specs.pdf">Argon2</a> recommended setting,
to account for the possibility that the NSA has machines a hundred times more powerful
than the rest of us, which is both unlikely, and would not cost what we estimated).</p>
<p>As a result, our formula for picking strength is
N = log2(B÷12÷0.03 · Y·365·24·3600÷0.005) + 1 = 77 bits of security.</p>
<p>Note that we can assume that a good KDF is used,
since we are only worried about password strength for the password manager,
which should be pretty good at choosing the right design.
The password manager will generate all normal passwords above 128 bits of security anyway.
(Except for those pesky websites that inexplicably have an upper password length limit.
But those are beyond saving.)</p>
<p>I parameterized some values so that you can plug your own situation.
For instance, if you make a password for your startup
that you believe will beat the odds of an average 5-year lifespan,
and become a behemoth a thousand years into the future, you can set Y = 1000
and get a very slight increase to 79 bits.</p>
<p>If you instead believe that your adversary will spend a trillion euros every year,
you can bump things up to 83 bits of security.</p>
<h2 id="Master_password_generation">Master password generation <a href="#Master_password_generation" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>How do you convert a number of bits of security into a master password?
Well, those bits represent the amount of entropy of the random generator.
Or in other words, the quantity of uncertainty of the password-making process.</p>
<p>Each bit represents one truly random choice between two options.
If you have four options, it is as if you made two choices, and so on.</p>
<p>A good way to make memorable master passwords is to pick words among large dictionaries,
since picking from a long list adds a lot of entropy (since there are so many binary choices)
but each word is very distinctively evocative.</p>
<p>However, each word is independent, and therefore,
making stories in your head that combines those words gets harder the more words there are.
So we randomize the word separators as symbols,
which both adds entropy (so that we can have less words),
and is not too hard to remember. Besides, breaking words apart ensures that
we don’t lose entropy by ending up with two words that, concatenated,
are actually a single word from the same dictionary.</p>
<p>I implemented these principles on <a href="https://espadrine.github.io/passphrase/">this passphrase generation page</a>.</p>
<h2 id="Thank_you_Next">Thank you, Next <a href="#Thank_you_Next" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>I feel strongly that passwords are passé.
I would love to talk about my hopes for the future of Web authentication.</p>
<p><a href="https://www.reddit.com/r/programming/comments/hf63bp/generate_cryptographically_secure_passphrases_at/">Reddit comments here</a>.
<a href="https://news.ycombinator.com/item?id=23632533">HN comments here</a>.</p>
<script type="application/ld+json">
{ "@context": "http://schema.org",
  "@type": "BlogPosting",
  "datePublished": "2020-06-24T19:50:27Z",
  "keywords": "crypto" }
</script> ]]>
        </content>
      </entry>
      <entry>
        <id>https://espadrine.github.io/blog/posts/shishua-the-fastest-prng-in-the-world.html</id>
        <link rel="alternate" type="text/html" href="https://espadrine.github.io/blog/posts/shishua-the-fastest-prng-in-the-world.html"/>
        <title>SHISHUA: The Fastest Pseudo-Random Generator In the World</title>
        <published>2020-04-18T16:59:00Z</published>
        <category term="prng"/>
<category term="crypto"/>
        <content type="html">
          <![CDATA[ <h1 id="SHISHUA_The_Fastest_Pseudo_Random_Generator_In_the_World">SHISHUA: The Fastest Pseudo-Random Generator In the World <a href="#SHISHUA_The_Fastest_Pseudo_Random_Generator_In_the_World" class="autolink-clicker" aria-hidden="true">§</a></h1>
<p><em>(TLDR: see the <a href="#benchmark">benchmark</a> and the <a href="https://github.com/espadrine/shishua">code</a>.)</em></p>
<p>Six months ago, I wanted to make the best PRNG with an unconventional design,
whatever that design may be.
I expected it to start easy, and slowly get harder;
I wondered whether I would learn fast enough to pass the highest bar.</p>
<p>Surprisingly, difficulty did not increase linearly.
Passing the bytewise Chi-Squared tests was very hard!</p>
<p>Then, when I got the concepts, passing dieharder was also very hard.
When I got to that point, I was honestly so extatic,
that <a href="https://mobile.twitter.com/espadrine/status/1184542865969614849">I published what I got</a> to learn what the next challenge needed to be.
But it turned out <a href="https://mobile.twitter.com/espadrine/status/1184883565634424832">it failed PractRand</a>.</p>
<p>Then, <a href="https://mobile.twitter.com/espadrine/status/1186358084425400320">passing BigCrush</a> was very hard.</p>
<p>Then, passing 32 tebibytes of PractRand was very hard.</p>
<p>But once I reached that point, I realized that speed was going to be an issue.
It wasn’t just about having a construction that emitted ten megabytes a second, taking a month to pass PractRand.</p>
<p>But I have to admit, <a href="https://github.com/espadrine/combit">passing PractRand at a gigabyte a second</a> was very hard.</p>
<p>Once you get there… what you really want to see is whether you can reach the Pareto frontier.</p>
<p>You want the fastest PRNG in the world that beats the hardest statistical tests.</p>
<p>I got there.</p>
<p>In <a href="https://espadrine.github.io/blog/posts/a-primer-on-randomness.html">the previous entry to the series</a>, I explained all the things I learnt to reach it.
Here, I’ll detail how the winning design works.</p>
<h2 id="Target">Target <a href="#Target" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Let’s start with the obvious: <strong>speed is platform-dependent</strong>.
I focused my optimization on the modern x86-64 architecture (so, Intel and AMD chips).</p>
<p>The classic metric used to compare performance there is <strong>cpb</strong>:
the number of CPU cycles spent to generate a byte of output.
All cryptographic papers <a href="https://bench.cr.yp.to/supercop.html">compute and compare that metric</a>.
A slightly lower cpb, in software or hardware, can weigh in the balance
just enough to make a primitive win a competition,
or become widely used by the major websites of the world.</p>
<p>To improve your cpb, you can do three things:</p>
<ol>
<li>Generate more bytes for the same amount of work, or</li>
<li>Do less work to generate the same amount of bytes, or</li>
<li>Parallelize work.</li>
</ol>
<p>We will do all of the above.</p>
<p>Therefore, to boot with point 1, we need to output more bits on each iteration.</p>
<p>I am worried that people might say,
“this is not a PRNG unless it outputs 32-bit numbers,” or “64-bit numbers”.
Or more generally, “PRNGs must only rely on this subset of x86-64”;
as if some instructions, such as <code>POPCNT</code>, or some registers, such as <code>%xmm7</code>, are off-limits.</p>
<p>But PRNGs are engineering: they try to make the best of the CPU, decade after decade!
They relied on <code>ROL</code> when it came, and on <code>%rax</code> when 64-bit CPUs landed.
Sure, it means that this algorithm might be slower on ARM (although that remains to be seen);
but 64-bit PRNGs were heavily used before 2019’s Android switch to a required 64-bit support!</p>
<p>So things evolve with the hardware.
And today, Intel and AMD CPUs support 256-bit operations through <a href="https://software.intel.com/en-us/articles/how-intel-avx2-improves-performance-on-server-applications">AVX2</a>.</p>
<p>Just like RC4 outputs 1 byte, and drand48 can only output 4 at a time;
just like pcg64 can only output 8 at a time;
we will output 32 bytes at a time.</p>
<p>Obviously, while 8 bytes could be output as a 64-bit number,
which most programming languages have a built-in type for,
few have a type for 16 bytes (C’s <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fint128.html"><code>__uint128_t</code></a> being a notable exception);
fewer yet have one for 32 bytes (aside from intrinsics).</p>
<p>So we must say goodbye to the typical PRNG function prototype
(here taken from Vigna’s <a href="http://xoshiro.di.unimi.it/hwd.c">HWD</a> benchmark program):</p>
<pre><code>static uint64_t next(void);
</code></pre>
<p>Instead, we can have the generator take a buffer to fill
(here taken from <a href="https://github.com/espadrine/shishua/blob/master/prng.c">my own benchmark program</a>):</p>
<pre><code>void prng_gen(prng_state *s, __uint64_t buf[], __uint64_t size);
</code></pre>
<p>Are there disadvantages?</p>
<p>Well, if your generator outputs 32 bytes at a time,
you need the consumer to give an array that is a multiple of 32 bytes;
ideally, an array aligned to 32 bytes.</p>
<p>Although, with a tiny bit more work, you don’t.
Just fill a buffer. Output from it what has not been consumed;
refill it as needed.</p>
<p>That does make <em>latency</em> unpredictable: some calls will only read the buffer.
But it averages out the same.</p>
<p>So now we generate more bytes for the same amount of work.
Next step: how do we parallelize work?</p>
<h2 id="Parallelism">Parallelism <a href="#Parallelism" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>The CPU offers an incredible wealth of parallelism at every level.</p>
<p>First, of course, are the SIMD instructions (Single-Instruction, Multiple Data).
For instance, AVX2 does four 64-bit additions in parallel, or eight 32-bit ones, etc.</p>
<p>In cryptography, it has been severely relied upon for fifteen years.
Notably, <a href="https://github.com/floodyberry/supercop/tree/master/crypto_stream/chacha20/dolbeau/amd64-avx2">ChaCha20</a> gains an incredible amount of speed from it;
most important primitives that don’t use AESNI rely on that.
For instance, <a href="https://norx.io/data/norx.pdf">NORX</a> and <a href="https://cryptojedi.org/papers/gimli-20170627.pdf">Gimli</a> are designed with that in mind.</p>
<p>Recently, there has been increasing interest in the non-cryptographic PRNG community.</p>
<p>In particular, existing primitives not designed for SIMD can be the basis
for building a very fast PRNG.</p>
<p>For instance, Sebastiano Vigna, while pushing for his <a href="http://prng.di.unimi.it/#speed">xoshiro256++</a> design
in the Julia programming language’s standard library,
<a href="https://github.com/JuliaLang/julia/issues/27614#issuecomment-548154730">learnt</a> that concatenating the output of eight concurrent instances of the PRNG
initialized differently, was made very fast by having each operation of the design
performed simultaneously on each PRNG.</p>
<p>SIMD is one level of CPU parallelism, but not the only one.
I encourage you to read <a href="https://espadrine.github.io/blog/posts/a-primer-on-randomness.html">the previous article on the subject</a>
to get a better picture, but I’ll mention what I relied upon.</p>
<p><strong>CPU pipelining</strong> processes multiple instructions at different stages of processing.
When well-ordered to limit interstage dependencies, instructions can be processed faster.</p>
<p><strong>Superscalar execution</strong> makes the computation part of instruction happen in parallel.
But they must have no read/write dependencies to do so.
We can fit the design to reduce the risk of stalls,
by making the write part happen long before the read.</p>
<p><strong>Out-of-order execution</strong> lets the processor execute instructions that happen later,
even though a previous instruction is not yet done, if the later instruction has no
read/write dependency to it.</p>
<p>All right, let’s dig our hands into the implementation!</p>
<h2 id="Design">Design <a href="#Design" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Let’s walk through the design of something we will call SHISHUA-half,
for reasons that will slowly become obvious along the article.</p>
<p>It looks like this:</p>
<p><img src="../assets/shishua-the-fastest-prng-in-the-world/shishua-diagram.svg" alt="SHISHUA diagram" /></p>
<p>Let’s dive in line by line.</p>
<pre><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">prng_state</span> {</span>
  __m256i state[<span class="hljs-number">2</span>];
  __m256i output;
  __m256i counter;
} prng_state;
</pre>
<p>Our state is cut in two pieces that both fit in an AVX2 register (256 bits).
We keep output around in the state to get a bit of speed,
but it is not actually part of the state.</p>
<p>We also have a 64-bit counter; it is also an AVX2 register to ease computation.
Indeed, AVX2 has a bit of a quirk where regular registers (<code>%rax</code> and the like)
cannot directly be transfered to the SIMD ones with a <code>MOV</code>;
it must go through RAM (typically the stack), which costs both latency and
two CPU instructions (<code>MOV</code> to the stack, <code>VMOV</code> from the stack).</p>
<p>We’re now going to look at generation.
We start by loading everything, then we loop over the buffer,
filling it up by 32 bytes at each iteration.</p>
<pre><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prng_gen</span><span class="hljs-params">(prng_state *s, <span class="hljs-keyword">__uint64_t</span> buf[], <span class="hljs-keyword">__uint64_t</span> size)</span> </span>{
  __m256i s0 = s-&gt;state[<span class="hljs-number">0</span>], counter = s-&gt;counter,
          s1 = s-&gt;state[<span class="hljs-number">1</span>],       o = s-&gt;output;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">__uint64_t</span> i = <span class="hljs-number">0</span>; i &lt; size; i += <span class="hljs-number">4</span>) {
    _mm256_storeu_si256((__m256i*)&amp;buf[i], o);
    <span class="hljs-comment">// …</span>
  }
  s-&gt;state[<span class="hljs-number">0</span>] = s0; s-&gt;counter = counter;
  s-&gt;state[<span class="hljs-number">1</span>] = s1; s-&gt;output  = o;
}
</pre>
<p>Since the function is inlined, the buffer being immediately filled at the start
lets the CPU execute the instructions that depend on it in the calling function right away,
through out-of-order execution.</p>
<p>Inside the loop, we perform three operations on the state in rapid succession:</p>
<ol>
<li><strong>SHI</strong>ft</li>
<li><strong>SHU</strong>ffle</li>
<li><strong>A</strong>dd</li>
</ol>
<p>Hence the name, SHISHUA!</p>
<h3 id="First_the_shift">First, the shift <a href="#First_the_shift" class="autolink-clicker" aria-hidden="true">§</a></h3>
<pre>u0 = _mm256_srli_epi64(s0, <span class="hljs-number">1</span>);              u1 = _mm256_srli_epi64(s1, <span class="hljs-number">3</span>);
</pre>
<p>AVX2 does not support rotations, sadly.
But I want to entangle bits from one position in the 64-bit numbers,
to other bit positions! And shift is the next best thing for that.</p>
<p>We must shift by an odd number so that each bit reaches all 64-bit positions,
and not just half.</p>
<p>Shift loses bits, which removes information from our state.
That is bad, so we minimize the loss: the smallest odd numbers are 1 and 3.
We use different shift values to increase divergence between the two sides,
which should help lower the similarity of their self-correlation.</p>
<p>We use rightward shift because the rightmost bits have the least diffusion in addition:
the low bit of <code>A+B</code> is just a XOR of the low bits of <code>A</code> and <code>B</code>, for instance.</p>
<h3 id="Second_the_shuffle">Second, the shuffle <a href="#Second_the_shuffle" class="autolink-clicker" aria-hidden="true">§</a></h3>
<pre>t0 = _mm256_permutevar8x32_epi32(s0, shu0); t1 = _mm256_permutevar8x32_epi32(s1, shu1);
</pre>
<p>We use a 32-bit shuffle because it is the only one that is both a different granularity
than the 64-bit operations that we do everywhere else (which breaks 64-bit alignment),
and that can also cross lanes
(other shuffles can only move bits within the left 128 bits if they started on the left,
or within the right 128 bits if they started on the right).</p>
<p>Here are the shuffle constants:</p>
<pre>__m256i shu0 = _mm256_set_epi32(<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>),
        shu1 = _mm256_set_epi32(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>);
</pre>
<p>To make the shuffle really strenghten the output, we move weak (low-diffusion) 32-bit parts
of the 64-bit additions to strong positions, so that the next addition will enrich it.</p>
<p>The low 32-bit part of a 64-bit chunk never moves to the same 64-bit chunk as its high part.
That way, they do not remain in the same chunk, encouraging mixing between chunks.</p>
<p>Each 32-bit part eventually reaches all positions circularly: A to B, B to C, … H to A.</p>
<p>You might notice that the simplest shuffle that follows all those requirements
are simply those two 256-bit rotations (rotation by 96 bits and 160 bits rightward, respectively).</p>
<h3 id="Third_the_addition">Third, the addition <a href="#Third_the_addition" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>Let’s add 64-bit chunks from the two temporary variables,
the shift one and the shuffle one, together.</p>
<pre>s0 = _mm256_add_epi64(t0, u0);              s1 = _mm256_add_epi64(t1, u1);
</pre>
<p>The addition is the main source of diffusion: it combines bits
into irreducible combinations of XOR and AND expressions across 64-bit positions.</p>
<p>Storing the result of the addition in the state keeps that diffusion permanently.</p>
<h3 id="Output_function">Output function <a href="#Output_function" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>So, where do we get the output from?</p>
<p>Easy: the structure we built is laid out in such a way that
we are growing two independent pieces of state: <code>s0</code> and <code>s1</code>,
which never influence each other.</p>
<p>So, we XOR them, and get something very random.</p>
<p>In fact, to increase the independence between the inputs that we XOR,
we take the partial results instead: the shifted piece of one state,
and the shuffled piece of the other.</p>
<pre><code>o = _mm256_xor_si256(u0, t1);
</code></pre>
<p>That also has the effect of reducing the read/write dependencies between superscalar CPU instructions,
as <code>u0</code> and <code>t1</code> are ready to be read before <code>s0</code> and <code>s1</code> are.</p>
<p>You may have noticed that we did not talk about the counter yet.
It turns out we handle it at the start of the loop.
We first change the state, and then increment the counter:</p>
<pre>s1 = _mm256_add_epi64(s1, counter);
counter = _mm256_add_epi64(counter, increment);
</pre>
<p>The reason we change the state first, and then update the counter,
is so that <code>s1</code> becomes available sooner,
reducing the risk that later instructions that will read it get stalled
in the CPU pipeline.
It also avoids a direct read/write dependency on the counter.</p>
<p>The reason we apply the counter to s1 and not s0,
is that both affect the output anyway.
However, <code>s1</code> loses more bits from the shift,
so this helps it get back on its feet after that harmful shearing.</p>
<p>The counter is not necessary to beat PractRand.
Its only purpose is to set a lower bound of 2<sup>69</sup> bytes = 512 EiB
to the period of the PRNG:
we only start repeating the cycle after one millenia at 10 GiB/s,
which is unlikely to ever be too low for practical applications in the coming centuries.
Thanks to this, there are no bad seeds.</p>
<p>Here are the increments:</p>
<pre>__m256i increment = _mm256_set_epi64x(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>);
</pre>
<p>The increments are picked as odd numbers,
since only coprimes of the base cover the full cycle of the finite field GF(2<sup>64</sup>),
and all odd numbers are coprime of 2.</p>
<p>(In other words, if you increment by an even number between integers 0 to 4,
wrapping around to 0 when you go past 4,
you get the sequence 0-2-0-2-…, which never outputs 1 or 3;
but an odd increment goes through all integers.)</p>
<p>We use a different odd number of each 64-bit number in the state,
which makes them diverge more, and adds a tiny bit of stirring.</p>
<p>I picked the smallest odd numbers so that they don’t look like magic numbers.</p>
<p>So, there we go! That is how the state transition and output function work.</p>
<p>Now, how do we initialize them?</p>
<h3 id="Initialization">Initialization <a href="#Initialization" class="autolink-clicker" aria-hidden="true">§</a></h3>
<p>We initialize the state with the hex digits of Φ,
the irrational number that is least approximable by a fraction.</p>
<pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">__uint64_t</span> phi[<span class="hljs-number">8</span>] = {
  <span class="hljs-number">0x9E3779B97F4A7C15</span>, <span class="hljs-number">0xF39CC0605CEDC834</span>, <span class="hljs-number">0x1082276BF3A27251</span>, <span class="hljs-number">0xF86C6A11D0C18E95</span>,
  <span class="hljs-number">0x2767F0B153D27B7F</span>, <span class="hljs-number">0x0347045B5BF1827F</span>, <span class="hljs-number">0x01886F0928403002</span>, <span class="hljs-number">0xC1D64BA40F335E36</span>,
};
</pre>
<p>We take a 256-bit seed, which is common in cryptography,
and doesn’t really hurt in non-cryptographic PRNGs:</p>
<pre><span class="hljs-function">prng_state <span class="hljs-title">prng_init</span><span class="hljs-params">(SEEDTYPE seed[<span class="hljs-number">4</span>])</span> </span>{
  prng_state s;
  <span class="hljs-comment">// …</span>
  <span class="hljs-keyword">return</span> s;
}
</pre>
<p>We don’t want to override a whole piece of state (<code>s0</code> nor <code>s1</code>) with the seed;
we only want to affect half.
That way, we avoid having debilitating seeds that,
purposefully or accidentally, set the state to a known weak start.</p>
<p>With half of each state intact, they still keep control over 128 bits of state,
which is enough entropy to start and stay strong.</p>
<pre>s.state[<span class="hljs-number">0</span>] = _mm256_set_epi64x(phi[<span class="hljs-number">3</span>], phi[<span class="hljs-number">2</span>] ^ seed[<span class="hljs-number">1</span>], phi[<span class="hljs-number">1</span>], phi[<span class="hljs-number">0</span>] ^ seed[<span class="hljs-number">0</span>]);
s.state[<span class="hljs-number">1</span>] = _mm256_set_epi64x(phi[<span class="hljs-number">7</span>], phi[<span class="hljs-number">6</span>] ^ seed[<span class="hljs-number">3</span>], phi[<span class="hljs-number">5</span>], phi[<span class="hljs-number">4</span>] ^ seed[<span class="hljs-number">2</span>]);
</pre>
<p>Then we do the following thing a <code>ROUNDS</code> number of times:</p>
<ol>
<li>Run <code>STEPS</code> iterations of SHISHUA,</li>
<li>Set one piece of the state to the other, and the other to the output.</li>
</ol>
<pre><span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> i = <span class="hljs-number">0</span>; i &lt; ROUNDS; i++) {
  prng_gen(&amp;s, buf, <span class="hljs-number">4</span> * STEPS);
  s.state[<span class="hljs-number">0</span>] = s.state[<span class="hljs-number">1</span>];
  s.state[<span class="hljs-number">1</span>] = s.output;
}
</pre>
<p>Setting to the output increases the diffusion of the state.
In the initialization, the added work and state correlation don’t matter,
since this is only done a few times, once.
You only care about diffusion in initialization.</p>
<p>I picked values of 5 for <code>STEPS</code> and 4 for <code>ROUNDS</code>
after looking at how much they impacted seed correlation.</p>
<p>(I computed seed correlation by counting the “unusual” and “suspicious” anomalies
coming out of the PractRand PRNG quality tool.)</p>
<h2 id="Performance">Performance <a href="#Performance" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>Speed measurement benchmarks are tricky for so many reasons.</p>
<ul>
<li><strong>Clock</strong> measurements can lack precision.</li>
<li>The CPU has so much <strong>parallelism</strong>, that tracking when instructions start and end,
is both nondeterministic and heavily dependent on other events on the CPU.</li>
<li>Obviously, from one CPU vendor to the next, the resuts will be different.
That is also true from one CPU <strong>series</strong> to the next from the same vendor.</li>
<li>CPUs nowadays have <strong><a href="https://www.intel.com/content/www/us/en/architecture-and-technology/turbo-boost/turbo-boost-technology.html">variable frequency</a></strong>: they get purposefully slower or faster
depending on the need for low power consumption or the risk of high temperature.</li>
</ul>
<p>I use a dedicated CPU instruction, <code>RDTSC</code>, which computes the number of cycles.</p>
<p>To make sure that everyone can reproduce my results, I use a cloud virtual machine.
It doesn’t change the order of the benchmark results compared to a local test;
it also avoids requesting that other people buy the same computer as the one I have.
Finally, there are many use-cases where PRNGs would be used in the cloud on those instances.</p>
<p>I chose Google Cloud Platform’s N2 (Intel chip) and N2D (AMD chip).
The advantage of GCP is that they have chips from both vendors.
We’ll focus on Intel here, but the orders of magnitude are similar for AMD.</p>
<p>To give a bit of context, let’s first look at an old cryptographic generator, RC4.
Impossible to parallelize; I got <strong>7.5 cpb</strong> (cycles spent per generated byte).</p>
<p>Now, let’s look at a very common and fast MCG: <a href="https://lemire.me/blog/2019/03/19/the-fastest-conventional-random-number-generator-that-can-pass-big-crush/">Lehmer128</a>,
the simplest PRNG that passes BigCrush: <strong>0.44 cpb</strong>. Wow, not bad!</p>
<p>For kicks, let’s make another detour through modern cryptographic designs.
They rely on a lot of the tricks that we saw.
Take ChaCha8 for instance.
It reaches… <strong>0.46 cpb</strong>! About the same as the really fast one we just saw!</p>
<p>SIMD really works its magic!</p>
<p>To the cryptographic community, <a href="https://twitter.com/hashbreaker/status/1023965175219728386">this is not a complete surprise</a>.
ChaCha8 is just insanely easy to parallelize.
It is just a counter in a diffused state, well-hashed.</p>
<p>Next, a recent mixer that is the basis for fast hash tables: <a href="https://github.com/wangyi-fudan/wyhash/blob/master/wyhash_v6.h">wyrand</a>.
<strong>0.41 cpb</strong>, slightly better!</p>
<p>Among Vigna’s fast PRNG, some don’t pass 32 TiB of PractRand, but are very fast.
<a href="http://prng.di.unimi.it/xoshiro256plus.c">Xoshiro256+</a> fails at 512 MiB but is among the fastest of the bunch: <strong>0.34 cpb</strong>.</p>
<p>Let’s look at a recent entry, from earlier this year: <a href="http://www.romu-random.org/">RomuTrio</a>.
It claims the title of fastest PRNG in the world: <strong>0.31 cpb</strong>.</p>
<p>Alright, enough. How does SHISHUA-half fare?</p>
<p><strong>0.14 cpb</strong>. Twice as fast as RomuTrio.</p>
<p><img src="../assets/shishua-the-fastest-prng-in-the-world/speed-partial.svg" alt="Speed plot" /></p>
<p>Given its quality, it is unmatched.</p>
<p>But remember how the Julia team looked at
combining multiple instances of Vigna’s design
to make a fast SIMD PRNG?
Let’s look at Vigna’s fastest result using this technique:
<a href="http://prng.di.unimi.it/#speed">Xoshiro256+ 8 times</a>. <strong>0.07 cpb</strong>!</p>
<p>(Technically, it varies on the machine;
on my laptop, SHISHUA-half is faster than this.)</p>
<hr />
<p>Sure, the resulting meta-PRNG (which I dub Xoshiro256+x8)
has <em>terrible statistical biases</em> that fail many simple tests.</p>
<p>But, let’s beat its speed anyway, without betraying our high quality standards.</p>
<p>Now you probably guess why we called our earlier primitive SHISHUA-half.</p>
<p>It turns out getting twice as fast is easy by doubling SHISHUA-half.</p>
<p>Similar to the Julia insights, we have two PRNGs initialized differently
(four blocks of 256-bit state),
outputting their thing one after the other.</p>
<p>But with more state, we can output even more stuff,
by combining the four states pairwise:</p>
<pre>o0 = _mm256_xor_si256(u0, t1);
o1 = _mm256_xor_si256(u2, t3);
o2 = _mm256_xor_si256(s0, s3);
o3 = _mm256_xor_si256(s2, s1);
</pre>
<p>And that is how you get SHISHUA, and its <strong>0.06 cpb</strong> speed.</p>
<p>Five times faster than the previously-fastest in the world
that passes 32 TiB of PractRand.
You can barely see it in the graph, so I removed RC4.</p>
<p><img src="../assets/shishua-the-fastest-prng-in-the-world/speed.svg" alt="Speed plot" /></p>
<p>I guess my point is that it is somewhat competitive.</p>
<p>(In fact, it is even faster on my laptop, at 0.03 cpb,
but I want to stick to my benchmark promises.
Maybe we lose a tiny bit of performance on early AVX-512 CPUs.)</p>
<p>Hopefully, SHISHUA stays the fastest in the world for at least a few weeks?
(Please make it so.)</p>
<h2 id="Quality">Quality <a href="#Quality" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>It passes BigCrush and 32 TiB of PractRand without suspicion.</p>
<p>In fact, all of its four outputs do.</p>
<p>One of the not-ideal aspects of the design is that SHISHUA is <strong>not reversible</strong>.</p>
<p>You can see this with a reduction to a four-bit state, with <code>s0 = [a, b]</code> and <code>s1 = [c, d]</code>.
The shift will yield <code>[0, a]</code> and <code>[0, d]</code>; the shuffle will give <code>[b, c]</code> and <code>[d, a]</code>.</p>
<p>The new <code>s0</code> is <code>[b, c] + [0, a] = [b⊕(a∧c), a⊕c]</code>, and <code>s1</code> is <code>[d, a] + [0, c] = [d⊕(a∧c), a⊕c]</code>.</p>
<p>If <code>a = ¬c</code>, then <code>a⊕c = 1</code> and <code>a∧c = 0</code>, thus <code>s0 = [b, 1]</code> and <code>s1 = [d, 1]</code>.
So there are two combinations of <code>a</code> and <code>c</code> that give the same final state.</p>
<p>It is not an issue in our case, because the 64-bit counter is also part of the state.
So you have a minimum cycle of 2⁷¹ bytes (128 bytes per state transition),
which lasts seven millenia at 10 GiB/s.
So that counterbalances the lost states.</p>
<p>Besides, even despite the irreversibility,
the average state transition period is <code>2^((256+1)÷2)</code>.
That gives an average cycle of 2¹³⁵ bytes
(more than a trillion times the age of the universe to reach at 10 GiB/s).
Although, in my opinion, average cycles are overrated,
as they give no indication on the quality of the output.</p>
<p>Alright, here is the distilled benchmark:</p>
<table id=benchmark>
  <tr><th>Name   <th>Performance <th>Quality <th>Seed correlation
  <tr><td>SHISHUA       <td>0.06 <td>>32 TiB <td> >32 TiB
  <tr><td>xoshiro256+x8 <td>0.07 <td>  1 KiB <td>   0 KiB
  <tr><td>RomuTrio      <td>0.31 <td>>32 TiB <td>   1 KiB
  <tr><td>xoshiro256+   <td>0.34 <td>512 MiB <td>   1 KiB
  <tr><td>wyrand        <td>0.41 <td>>32 TiB <td>  32 KiB
  <tr><td>Lehmer128     <td>0.44 <td>>32 TiB <td>   1 KiB
  <tr><td>ChaCha8       <td>0.46 <td>>32 TiB?<td> >32 TiB?
  <tr><td>RC4           <td>8.06 <td>  1 TiB <td>   1 KiB
</table>
<ol>
<li><strong>Performance</strong>: in number of CPU cycles spent per byte generated,
on N2 GCP instances. On N2D (AMD), the order is the same.</li>
<li><strong>Quality</strong>: level at which it fails PractRand. We show a <code>&gt;</code> if it did not fail.
We put a question mark if we have not proved it.</li>
<li><strong>Seed correlation</strong>: PractRand on interleaving of bytes from eight streams
with seeds 1, 2, 4, 8, 16, 32, 64, 128.
We use PractRand with folding 2 and expanded tests.</li>
</ol>
<p>Speed measurement is traditionally in cpb.
Given the speed we get to nowadays,
a more appropriate measurement is in number of bits generated per CPU cycle.
Not only do I find it easier to grasp,
it is also much easier to compare huge differences on the graph:</p>
<p><img src="../assets/shishua-the-fastest-prng-in-the-world/speed-total.svg" alt="Speed plot" /></p>
<h2 id="Next">Next <a href="#Next" class="autolink-clicker" aria-hidden="true">§</a></h2>
<p>While there are no practical issue with irreversibility in our case,
it also means that we can improve on SHISHUA.</p>
<p>My ideal PRNG would have the following properties:</p>
<ol>
<li><strong>The state transition is a circular permutation</strong>, giving a way-more-than-enough 2¹⁰²⁴ bytes cycle.
As in, it would take more than 10²⁸² times the age of the universe to reach the end at 10 GiB/s,
instead of SHISHUA’s seven millenia.
It is not exactly “better” (impossible is impossible);
but if we can reduce the design to a smaller state without affecting diffusion,
we might be able to get a faster PRNG.
Do you think we might be able to fit one in ARM’s 128-bit NEON registers?
Also, we would no longer need the counter, removing two additions.</li>
<li><strong>The output function is provably irreversible</strong>.
The way SHISHUA XORs two independent numbers already has that property,
but I haven’t proved that the numbers are truly decorrelated.</li>
<li><strong>The state initialization is irreversible</strong>
with each state having 2¹²⁸ possible seeds (to prevent guessing the seed).
The way SHISHUA sets the state to its own output is likely irreversible.
After all, it uses SHISHUA’s state transition (partially irreversible)
and its output function (seemingly irreversible, see point 2).</li>
<li><strong>The state initialization has perfect diffusion</strong>:
all seed bits affect all state bits with equal probability.
I’d like to compute that for SHISHUA.</li>
</ol>
<p>One issue holding back PRNGs and cryptography overall is the lack of better, general-purpose tooling.</p>
<p>I want a tool that can instantly give me an accurate score,
allowing me to compare designs on the spot.</p>
<p>PractRand is great compared to what came before it; but:</p>
<ul>
<li>It cannot rate high-quality generators, making comparisons between them impossible.
We just get to say “well, they both had no anomalies after 32 TiB…”</li>
<li>It takes weeks to run…</li>
</ul>
<p>I believe great improvements are coming.</p>
<hr />
<p>Discussions on
<a href="https://www.reddit.com/r/prng/comments/g3nh4i/shishua_the_fastest_prng_in_the_world/">Reddit</a>
and
<a href="https://news.ycombinator.com/item?id=22907539">Hacker News</a>
.</p>
<script type="application/ld+json">
{ "@context": "http://schema.org",
  "@type": "BlogPosting",
  "datePublished": "2020-04-18T16:59:00Z",
  "keywords": "prng, crypto" }
</script> ]]>
        </content>
      </entry>
</feed>
